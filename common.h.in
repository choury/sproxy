#ifndef COMMON_H__
#define COMMON_H__

#include <stdio.h>
#include <stddef.h>
#include <stdint.h>
#include <syslog.h>
#include <arpa/inet.h>
#include <sys/epoll.h>


#define Min(x, y) ((int64_t)(x) < (int64_t)(y)?(x):(y))
#define Max(x, y) ((int64_t)(x) > (int64_t)(y)?(x):(y))

#define DOMAINLIMIT   256
#define HEADLENLIMIT  8192
#define URLLIMIT      4096

#define BUF_LEN       16384

typedef enum{TCP=SOCK_STREAM, UDP=SOCK_DGRAM, ICMP, RUDP}Protocol;

extern char **main_argv;
extern char SPROT[];
extern char SHOST[];
extern uint16_t SPORT;
extern int daemon_mode;
extern int ignore_cert_error;
extern int disable_ipv6;
extern int use_http2;
extern char auth_string[];
extern char rewrite_auth[];
extern const char *cafile;
extern const char *index_file;
extern uint32_t debug;
extern int autoindex;


#define DEPOLL    1
#define DDNS      2
#define DDTLS     4
#define DHTTP2    8
#define DJOB      16
#define DVPN      32
#define DHPACK    64
#define DRUDP     128

#define DEPOLL_STR  "[EPOLL]"
#define DDNS_STR    "[DNS]"
#define DDTLS_STR   "[DTLS]"
#define DHTTP2_STR  "[HTTP2]"
#define DJOB_STR    "[JOB]"
#define DVPN_STR    "[VPN]"
#define DHPACK_STR  "[HPACK]"
#define DRUDP_STR   "[RUDP]"

#ifdef __ANDROID__
#include "com_choury_sproxy_Service.h"
#define LOG_RAW(level, ...) android_log(level, __VA_ARGS__)
#else
#define LOG_RAW(level, ...) \
do{\
    if(daemon_mode){\
        syslog(level, __VA_ARGS__);\
    }else{ \
        if(level <= LOG_ERR){\
            fprintf(stderr, __VA_ARGS__);\
        }else{\
            fprintf(stdout, __VA_ARGS__);\
        }\
    }\
}while(0)
#endif

#define  LOG(...)  LOG_RAW(LOG_INFO,  __VA_ARGS__)
#define  LOGE(...) \
do{\
    char tmp[1024]; \
    snprintf(tmp, sizeof(tmp), __VA_ARGS__); \
    LOG_RAW(LOG_ERR, "%s[%d]: %s", __PRETTY_FUNCTION__, __LINE__, tmp);\
}while(0)

#ifndef NDEBUG
#define  LOGD(mod, ...)  \
do{\
    if(debug & mod) {\
        char tmp[1024]; \
        snprintf(tmp, sizeof(tmp), __VA_ARGS__); \
        LOG_RAW(LOG_DEBUG, "%s: %s",mod##_STR, tmp); \
    }\
}while(0)

#else
#define LOGD(...)          void(0)
#endif


#ifdef  __cplusplus
extern "C" {
#endif

#ifndef __ANDROID__
#define HTONL(x) (x = htonl(x))
#define HTONS(x) (x = htons(x))


#define NTOHL(x) (x = ntohl(x))
#define NTOHS(x) (x = ntohs(x))
#else
#define SCNx64   "llx"
#define SCNu64   "llu"
#endif

#define get16(a)  (((uchar*)(a))[0]<<8 | ((uchar*)(a))[1])
#define set16(a, x) \
do {\
    ((uchar*)(a))[0] = ((x)>>8) & 0xff;\
    ((uchar*)(a))[1] = (x) & 0xff;\
}while(0);

#define get24(a) (((uchar*)(a))[0]<<16 | ((uchar*)(a))[1]<<8 | ((uchar*)(a))[2])
#define set24(a, x) \
do {\
    ((uchar*)(a))[0] = ((x)>>16) & 0xff;\
    ((uchar*)(a))[1] = ((x)>>8) & 0xff;\
    ((uchar*)(a))[2] = (x) & 0xff;\
}while(0);

#define get32(a) (((uchar*)(a))[0]<<24 | ((uchar*)(a))[1]<<16 | ((uchar*)(a))[2]<<8 | ((uchar*)(a))[3])
#define set32(a, x) \
do {\
    ((uchar*)(a))[0] = ((x)>>24) & 0xff;\
    ((uchar*)(a))[1] = ((x)>>16) & 0xff;\
    ((uchar*)(a))[2] = ((x)>>8) & 0xff;\
    ((uchar*)(a))[3] = (x) & 0xff;\
}while(0);

#define get64(a) \
    ((uint64_t)((uchar*)(a))[0]<<56 |\
     (uint64_t)((uchar*)(a))[1]<<48 |\
     (uint64_t)((uchar*)(a))[2]<<40 |\
     (uint64_t)((uchar*)(a))[3]<<32 |\
     (uint64_t)((uchar*)(a))[4]<<24 |\
     (uint64_t)((uchar*)(a))[5]<<16 |\
     (uint64_t)((uchar*)(a))[6]<<8 |\
     (uint64_t)((uchar*)(a))[7])

#define set64(a, x) \
do {\
    ((uchar*)(a))[0] = ((uint64_t)(x)>>56) & 0xff;\
    ((uchar*)(a))[1] = ((uint64_t)(x)>>48) & 0xff;\
    ((uchar*)(a))[2] = ((uint64_t)(x)>>40) & 0xff;\
    ((uchar*)(a))[3] = ((uint64_t)(x)>>32) & 0xff;\
    ((uchar*)(a))[4] = ((uint64_t)(x)>>24) & 0xff;\
    ((uchar*)(a))[5] = ((uint64_t)(x)>>16) & 0xff;\
    ((uchar*)(a))[6] = ((uint64_t)(x)>>8) & 0xff;\
    ((uchar*)(a))[7] = ((uint64_t)x) & 0xff;\
}while(0);

#define likely(x)   __builtin_expect(!!(x), 1)
#define unlikely(x) __builtin_expect(!!(x), 0)

#define NOERROR             0
#define SOCKET_ERR          80
#define CONNECT_FAILED      81
#define CONNECT_TIMEOUT     82
#define SSL_SHAKEHAND_ERR   83
#define HEAD_TOO_LONG_ERR   84
#define HTTP_PROTOCOL_ERR   85
#define READ_ERR            86
#define WRITE_ERR           87
#define PEER_LOST_ERR       88
#define IP_BLOCK_ERR        89
#define TCP_RESET_ERR       90
#define DNS_FAILED          91
#define VPN_AGED_ERR        92
#define SNI_HOST_ERR        93
#define ERROR_MASK          0xff
#define DISCONNECT_FLAG     (1<<31)

typedef unsigned char uchar;


int protectFd(int sockfd);

struct write_block{
    void* buff;
    size_t len;
    size_t wlen;
};


union sockaddr_un{
    struct sockaddr addr;
    struct sockaddr_in addr_in;
    struct sockaddr_in6 addr_in6;
};

#cmakedefine01 Backtrace_FOUND
#if Backtrace_FOUND
#include <@Backtrace_HEADER@>
#endif

#ifdef  __cplusplus
}
#endif

#endif
